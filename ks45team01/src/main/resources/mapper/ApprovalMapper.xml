<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper	namespace="ks45team01.unity.mapper.ApprovalMapper">
	<resultMap type="Approval" id="approvalResultMap">
		<id property="draftDocNum" 				column="draft_doc_num"/>
		<result property="approvalCategoryNum" 	column="approval_category_num"/>
		<result property="draftTitle" 			column="draft_title"/>
		<result property="registrantNum" 		column="registrant_num"/>
		<result property="reportDate" 			column="report_date"/>
		<result property="draftContents" 		column="draft_contents"/>
		<result property="draftAddfile" 		column="draft_addfile"/>
		<result property="draftAddfilePath" 	column="draft_addfile_path"/>
		<result property="draftDeadline" 		column="draft_deadline"/>
		<result property="draftRegDate" 		column="draft_reg_date"/>
		<result property="approvalFinalState" 	column="approval_final_state"/>
		<association property="approvalProcess" javaType="ApprovalProcess">
			<id property="approvalProcessNum" 		column="approval_process_num"/>
			<result property="approvalLineNum" 		column="approval_line_num"/>
			<result property="draftDocNum" 			column="draft_doc_num"/>
			<result property="processStatus" 		column="process_status"/>
			<result property="rejectReasonMember"	column="reject_reason_member"/>
			<result property="rejectReason" 		column="reject_reason"/>
			<result property="rejectDate" 			column="reject_date"/>
			<result property="approvalDoneDate" 	column="approval_done_date"/>
		</association>
		<association property="approvalLine" javaType="ApprovalLine">
			<id property="approvalLineNum" 			column="approval_line_num"/>
			<result property="draftDocNum" 			column="draft_doc_num"/>
			<result property="approvalMemberNum" 	column="approval_member_num"/>
			<result property="finalApproverNum" 	column="final_approver_num"/>
			<result property="finalApprover"		column="final_approver"/>
			<result property="approvalSequence" 	column="approval_sequence"/>
		</association>
	</resultMap>
	<resultMap type="VacationApproval" id="vacationApprovalResultMap">
		<id property="vacationApprovalNum" 				column="vacation_approval_num"/>
		<result property="draftDocNum" 			column="draft_doc_num"/>
		<result property="vacationTypeNum" 			column="vacation_type_num"/>
		<result property="vacationTitle" 		column="vacation_title"/>
		<result property="memberNum" 		column="member_num"/>
		<result property="draftSend" 	column="draft_send"/>
		<result property="vacationStartDate" 		column="vacation_start_date"/>
		<result property="vacationEndDate" 		column="vacation_end_date"/>
		<result property="totalVacationUseDate" 	column="total_vacation_use_date"/>
		<result property="totalVacationUseTime" 		column="total_vacation_use_time"/>
		<result property="vacationReason" 	column="vacation_reason"/>
		<result property="emergencyContact" 		column="emergency_contact"/>
		<result property="replaceMember" 		column="replace_member"/>
		<result property="approvalDeadline" 	column="approval_deadline"/>
	</resultMap>
	<update id="approvalDoneProcess" parameterType="String">
		/* 결재 완료 처리 */
		UPDATE tb_approval_process AS ap INNER JOIN tb_draft_document AS d
			SET
				d.approval_final_state='결재완료'
			WHERE d.draft_doc_num=#{draftDocNum};
	</update>
	<insert id="approvalApprove" parameterType="String">
		INSERT INTO tb_approval_process
			(approval_process_num, draft_doc_num, process_status, approval_done_date)
			VALUES (sf_approvalProcessNum(), #{draftDocNum}, '승인', NOW());
	</insert>
	<select id="getCommonNewCode" parameterType="String" resultType="String">
		/* 자동증가코드 */
		SELECT
			CASE
			WHEN COUNT(1) = 0 THEN CONCAT(#{column}, '_1')
			ELSE
				CONCAT(#{column},'_', MAX(CAST(SUBSTRING_INDEX(${column}, CONCAT(#{column}, '_'), -1) AS UNSIGNED))+1)
			END AS newCode
		FROM
			${table};
	</select>
	<insert id="addDraftInsert" parameterType="Approval">
		INSERT INTO tb_draft_document
		(draft_doc_num, draft_title, registrant_num, report_date, draft_contents, draft_deadline, approval_final_state)
		VALUES (#{draftDocNum}, #{draftTitle}, #{registrantNum}, NOW(), #{draftContents}, #{draftDeadline}, '결재진행중')
	</insert>
	<insert id="addApprovalMember" parameterType="list">
		INSERT INTO tb_approval_line
		(approval_line_num, draft_doc_num, approval_member_num)
		VALUES 
		<foreach collection="list" item="item" separator=", " >
	        (sf_approvalLineNum(), #{item.draftDocNum}, #{item.approvalMemberNum})
	    </foreach>
	</insert>
	<select id="rejectList" resultType="list" resultMap="approvalResultMap">
	/* 반려 목록 조회 */
		SELECT 
			*
		FROM 
			tb_approval_process AS ap
			INNER JOIN 
			tb_draft_document AS d
			ON
			ap.draft_doc_num = d.draft_doc_num
			WHERE ap.reject_date IS NOT NULL;
	</select>
	<insert id="addRejectReason" parameterType="String">
		/* 반려 사유 등록 */
		INSERT INTO tb_approval_process
		(approval_process_num, draft_doc_num, process_status, reject_reason_member, reject_reason, reject_date)
		VALUES (sf_approvalProcessNum(), #{draftDocNum}, '반려', #{rejectReasonMember}, #{rejectReason}, NOW());
	</insert>
	<update id="rejectProcess" parameterType="String">
		UPDATE tb_draft_document
			SET
				approval_final_state='결재반려'
			WHERE draft_doc_num=#{draftDocNum};
	</update>
	<select id="approvalDoneList" resultMap="approvalResultMap" resultType="list">
			/* 결재 완료 목록 조회 */
		SELECT 
			*
		FROM 
			tb_draft_document AS d
			INNER JOIN 
			tb_approval_process AS ap
			ON 
			d.draft_doc_num = ap.draft_doc_num
			WHERE approval_final_state = '결재완료'
			AND process_status = '승인';
	</select>
	
	<select id="approvalList" resultMap="approvalResultMap" resultType="list">
		/* 결재 진행 목록 조회 */
		SELECT 
			*
		FROM 
			tb_draft_document
		WHERE approval_final_state = '결재진행중';	
	</select>
	
	<select id="draftView" parameterType="String" resultMap="approvalResultMap">
		/* 개별 기안문서 상세보기 */
		SELECT 
			*
		FROM 
			tb_draft_document AS d
			LEFT JOIN 
			tb_approval_process AS ap
			ON 
			d.draft_doc_num = ap.draft_doc_num
		WHERE d.draft_doc_num = #{draftDocNum};
	</select>
	<select id="rejectView" parameterType="String" resultMap="approvalResultMap">
		/* 반려 기안문서 상세보기 */
		SELECT 
			*
		FROM 
			tb_draft_document AS d
			INNER JOIN 
			tb_approval_process AS ap
			ON 
			d.draft_doc_num = ap.draft_doc_num
		WHERE d.draft_doc_num = #{draftDocNum};
	</select>
	
	<select id="draftList" resultMap="approvalResultMap" resultType="list" parameterType="String">
		/* 기안문서 목록 조회 */
		SELECT 
			*
		FROM 
			tb_draft_document AS d
		WHERE d.registrant_num = #{registrantNum}
		ORDER BY LENGTH(d.draft_doc_num),d.draft_doc_num;
	</select>
	<insert id="addVacationApproval" parameterType="VacationApproval">
		/* 연차신청서 등록 */
		INSERT INTO tb_vacation_approval
		(vacation_approval_num, draft_doc_num, vacation_type_num, vacation_title, member_num, draft_send, vacation_start_date, vacation_end_date, total_vacation_use_date, total_vacation_use_time, vacation_reason, emergency_contact, replace_member, approval_deadline)
		VALUES (#{vacationApprovalNum}, #{draftDocNum}, #{vacationTypeNum}, #{vacationTitle},#{memberNum}, #{draftSend}, #{vacationStartDate}, #{vacationEndDate}, #{totalVacationUseDate}, #{totalVacationUseTime}, #{vacationReason},#{emergencyContact}, #{replaceMember}, #{approvalDeadline});
	</insert>
	<insert id="addWorkCorrectApproval" parameterType="WorkCorrectApproval">
		/* 근태등록 신청서 등록 */
		INSERT INTO tb_work_correct_approval
		(work_correct_num, work_num, work_category_num, draft_doc_num, work_correct_title, member_num, draft_send, correct_attendance_time, correct_leavework_time, correct_reason, approval_deadline)
		VALUES (#{workCorrectNum}, #{workNum}, #{workCategoryNum}, #{draftDocNum}, #{workCorrectTitle}, #{memberNum}, #{draftSend}, #{correctAttendanceTime}, #{correctLeaveworkTime}, #{correctReason}, #{approvalDeadline});
	</insert>
</mapper>